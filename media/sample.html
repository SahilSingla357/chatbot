<html>
<head>
</head>
<body>
<h1>sample site</h1>
</body>

<script>var vendor="1";var HTMLTEXT='<button class=open-button onclick=openChat()>Chat</button> <div class="chat-popup form-container" id=myForm> <div id=header> <h1>Chat</h1> </div> <div class=container id=feedback> <form> <label for=fname>First Name</label> <input type=text id=fname name=firstname placeholder="First Name"> <br> <label for=lname>Last Name</label> <input type=text id=lname name=lastname placeholder="Last Name"> <br> <label for=subject>Feedback</label> <textarea id=subject name=subject placeholder="Write something.."></textarea> <input type=submit onclick=FormSubmit() value=Submit> </form> </div> <div class=chatflow id=chatflow> <ul id=messages> </ul> <div class=responses id=responses-div> <ul id=response-list> </ul> </div> <div> <button type=button class="btn cancel" onclick=closeChat()>Close</button> </div> </div>';var CSSTEXT='.chat-bot{font-family:Arial,Helvetica,sans-serif;box-sizing:border-box}.open-button{background-color:#555;color:white;padding:16px 20px;border:none;cursor:pointer;opacity:.8;position:fixed;bottom:23px;right:28px;width:280px}.chat-popup{display:none;position:fixed;bottom:0;right:15px;border:3px solid #f1f1f1;z-index:9}.form-container{width:300px;padding:10px;background-color:white}.form-container .btn{background-color:#4CAF50;color:white;padding:16px 20px;border:none;cursor:pointer;width:100%;margin-bottom:10px;opacity:.8}.form-container .cancel{background-color:red}.form-container .btn:hover,.open-button:hover{opacity:1}.responses{cursor:pointer}.container{display:none}';var bootstrap='<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css"><script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js">'+'</'+'script>'+'<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js">'+'</'+'script>';var siteDomain="http://localhost:8000/";var head=document.getElementsByTagName("head")[0].innerHTML;document.getElementsByTagName("head")[0].innerHTML=head+bootstrap;var chatBotDiv=document.createElement("div");chatBotDiv.setAttribute("class","chat-bot");var body=document.getElementsByTagName("body")[0];body.appendChild(chatBotDiv);chatBotDiv.innerHTML=HTMLTEXT;if(document.getElementsByTagName("style")[0])
{document.getElementsByTagName("style")[0].innerHTML=CSSTEXT;}
else{var style=document.createElement("style");document.getElementsByTagName("head")[0].appendChild(style);style.innerHTML=CSSTEXT;}
var refreshButton=document.createElement("button");refreshButton.setAttribute("class","refresh-button");refreshButton.setAttribute("id","refresh-button");refreshButton.setAttribute("onclick","refresh()");refreshButton.setAttribute("data-toggle","tooltip");refreshButton.setAttribute("data-placement","left");refreshButton.setAttribute("title","refresh");document.getElementsByTagName('body')[0].appendChild(refreshButton);var refreshIcon=document.createElement("span");refreshIcon.setAttribute("class","glyphicon glyphicon-refresh");document.getElementById("refresh-button").appendChild(refreshIcon);function questionAsked(questionText){var quesMessage=document.createElement("LI");quesMessage.setAttribute("class","messages question-asked");quesMessage.appendChild(document.createTextNode(questionText));document.getElementById("messages").appendChild(quesMessage);}
function responseOptions(res){var questionNext=res.question_next;var responseText=res.response_text;var responseElement=document.createElement("LI");responseElement.setAttribute("data-question-next",questionNext);responseElement.setAttribute("onclick","fetchQuestion(this)");responseElement.appendChild(document.createTextNode(responseText));document.getElementById("response-list").appendChild(responseElement);}
function responseMessage(respMessage){var responseElement=document.createElement("LI");responseElement.setAttribute("class","messages user-response");responseElement.appendChild(document.createTextNode(respMessage));document.getElementById("messages").appendChild(responseElement);}
function openChat(){document.getElementById("myForm").style.display="block";if(document.getElementById("messages").childNodes[1])
{return;}
else if(localStorage.getItem("last_Question")=='-1')
{document.getElementById("feedback").style.display="block";document.getElementById("myForm").removeChild(document.getElementById("chatflow"))
return;}
else if(localStorage.getItem("last_Question")){var chatHistory=localStorage.getItem("chatHistory")
chatHistory=JSON.parse(chatHistory)
for(var count=0;count<chatHistory.length;count++){questionAsked(chatHistory[count].question);responseMessage(chatHistory[count].response);}
var questionId=parseInt(localStorage.getItem("last_Question"));fetch(siteDomain+"api/vendor/"+vendor+"/question/"+questionId).then(res=>res.json()).then(function(response){questionAsked(response.question_text);for(res of response.response_data){responseOptions(res);}});return;}
fetch(siteDomain+"api/vendor/"+vendor+"/questions/?ifq=true").then(res=>res.json()).then(function(response){response=response[0];questionAsked(response.question_text);localStorage.setItem("last_Question",response.id);for(res of response.response_data){responseOptions(res);}});}
function fetchQuestion(resp){respMessage=resp.innerHTML;var question_next=resp.dataset.questionNext;if(question_next=="null"){localStorage.setItem("last_Question",-1);responseMessage(respMessage);saveChat();var responseList=document.getElementById("response-list");responseList.parentNode.removeChild(responseList);document.getElementById("feedback").style.display="block";document.getElementById("myForm").removeChild(document.getElementById("chatflow"));return;}
responseMessage(respMessage);var questionNextId=resp.dataset.questionNext;debugger;var responseList=document.getElementById("response-list");responseList.parentNode.removeChild(responseList);var responseDiv=document.getElementById("responses-div");var responseList=document.createElement("UL");responseList.setAttribute("id","response-list");responseDiv.appendChild(responseList);localStorage.removeItem("last_Question");localStorage.setItem("last_Question",parseInt(questionNextId,10));fetch(siteDomain+"api/vendor/"+vendor+"/question/"+questionNextId).then(res=>res.json()).then(function(response){questionAsked(response.question_text);for(res of response.response_data){responseOptions(res);}});}
function closeChat(){document.getElementById("myForm").style.display="none";}
function FormSubmit(){var fname=document.getElementById("fname").value;var lname=document.getElementById("lname").value;var feedback=document.getElementById("subject").value;var input={"first_name":fname,"last_name":lname,"feedback":feedback,}
var response=fetch(siteDomain+"api/user/feedback/",{method:'POST',headers:{'Content-Type':'application/json;charset=utf-8'},body:JSON.stringify(input)});localStorage.removeItem("last_Question");}
function saveChat(){debugger;var chatHistory=[];var chat=document.getElementById("messages");chat=chat.getElementsByTagName("li");var count=0;while(count<((chat.length%2==0)?(chat.length):(chat.length-1))){chatHistory.push({question:chat[count].innerHTML,response:chat[count+1].innerHTML});count=count+2;}
chatHistory=JSON.stringify(chatHistory);localStorage.setItem("chatHistory",chatHistory);}
function refresh(){closeChat();chatBotDiv.innerHTML=HTMLTEXT;localStorage.removeItem("chatHistory");localStorage.removeItem("last_Question");}
window.addEventListener("unload",function(){saveChat();});</script>

</html>
